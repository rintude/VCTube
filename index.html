<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VcalL - Connect</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg: #020617;
            --panel: #1e293b;
            --accent: #22d3ee;
            --danger: #ef4444;
            --text: #f8fafc;
        }

        body {
            margin: 0; font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg); color: var(--text);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* Setup Screen */
        #setup {
            position: fixed; inset: 0; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle, #1e293b 0%, #020617 100%);
        }

        .card {
            background: var(--panel); padding: 30px; border-radius: 20px;
            border: 2px solid var(--accent); width: 300px; text-align: center;
            box-shadow: 0 0 30px rgba(34, 211, 238, 0.3);
        }

        input {
            width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px;
            border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box;
        }

        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            font-weight: bold; cursor: pointer; transition: 0.2s;
        }

        .btn-join { background: var(--accent); color: var(--bg); margin-top: 10px; }
        .btn-join:hover { filter: brightness(1.2); }

        /* Video Grid */
        #video-container {
            flex: 1; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px; padding: 10px; box-sizing: border-box; align-content: start;
        }

        .video-box {
            position: relative; background: #000; border-radius: 12px;
            overflow: hidden; border: 1px solid #334155; aspect-ratio: 1;
        }

        video { width: 100%; height: 100%; object-fit: cover; }
        .mirror { transform: scaleX(-1); }

        .label {
            position: absolute; bottom: 8px; left: 8px;
            background: rgba(0,0,0,0.7); padding: 4px 10px;
            border-radius: 5px; font-size: 12px; border: 1px solid var(--accent);
        }

        /* Controls */
        #controls {
            background: var(--panel); padding: 15px; display: none;
            justify-content: center; border-top: 2px solid var(--accent);
        }

        .btn-leave { background: var(--danger); color: white; width: 150px; }

        /* Call Alert */
        #alert-box {
            display: none; position: fixed; top: 20px; right: 20px;
            background: var(--panel); border: 2px solid var(--accent);
            padding: 15px; border-radius: 10px; z-index: 200;
        }
    </style>
</head>
<body>

    <audio id="beep" src="https://www.soundjay.com/buttons/sounds/button-37a.mp3"></audio>

    <div id="setup">
        <h1 style="color:var(--accent); letter-spacing:8px;">VcalL</h1>
        <div class="card">
            <input type="text" id="uName" placeholder="Enter Your Name">
            <input type="text" id="rCode" placeholder="Room Code (e.g. 1010)">
            <button class="btn btn-join" onclick="startVcalL()">CONNECT</button>
        </div>
    </div>

    <div id="alert-box">
        <p id="alert-msg">Incoming Call...</p>
        <button class="btn btn-join" onclick="acceptCall()">Accept</button>
        <button class="btn btn-leave" style="width:100%; margin-top:5px;" onclick="declineCall()">Decline</button>
    </div>

    <div id="video-container"></div>

    <div id="controls">
        <button class="btn btn-leave" onclick="location.reload()">LEAVE ROOM</button>
    </div>

    <script>
        let myStream;
        let myPeer;
        let isJoined = false;
        let currentIncomingCall = null;
        const peers = {};

        async function startVcalL() {
            if (isJoined) return;
            const name = document.getElementById('uName').value;
            const room = document.getElementById('rCode').value;

            if (!name || !room) return alert("Enter Name and Room Code");

            try {
                myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                isJoined = true;
                document.getElementById('setup').style.display = 'none';
                document.getElementById('controls').style.display = 'flex';
                
                addVideo(myStream, name + " (You)", true);

                // Create a unique Peer ID based on Room + Name
                // We use a simple hash of the name to create a unique suffix
                const peerId = `vcall-${room}-${name.replace(/\s+/g, '').toLowerCase()}`;
                myPeer = new Peer(peerId);

                myPeer.on('open', (id) => {
                    console.log('Connected with ID:', id);
                    // In a simple system, we broadcast to anyone who might be in the room
                    // Note: Real multi-user requires a signaling server. 
                    // This PeerJS logic works best for 1-on-1 unless users call each other.
                });

                myPeer.on('call', call => {
                    document.getElementById('beep').play();
                    currentIncomingCall = call;
                    document.getElementById('alert-box').style.display = 'block';
                    document.getElementById('alert-msg').innerText = `Call from ${call.peer.split('-')[2]}`;
                });

                // Auto-connect logic: If user is joining, they need someone to call.
                // For direct "Room" feel, the second person should call the first.
                // Try calling the "Room ID" if you aren't the host.
            } catch (e) {
                alert("Camera Access Denied");
            }
        }

        function acceptCall() {
            document.getElementById('alert-box').style.display = 'none';
            currentIncomingCall.answer(myStream);
            currentIncomingCall.on('stream', userStream => {
                const remoteName = currentIncomingCall.peer.split('-')[2] || "Guest";
                addVideo(userStream, remoteName, false);
            });
        }

        function declineCall() {
            document.getElementById('alert-box').style.display = 'none';
            currentIncomingCall.close();
        }

        function addVideo(stream, label, isLocal) {
            const id = isLocal ? 'local' : stream.id;
            if (document.getElementById(id)) return;

            const box = document.createElement('div');
            box.id = id;
            box.className = 'video-box';
            
            const v = document.createElement('video');
            v.srcObject = stream;
            v.autoplay = true;
            v.playsInline = true;
            if (isLocal) { v.muted = true; v.classList.add('mirror'); }

            const l = document.createElement('div');
            l.className = 'label';
            l.innerText = label;

            box.append(v, l);
            document.getElementById('video-container').append(box);
        }
    </script>
</body>
</html>
