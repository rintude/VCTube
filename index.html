<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>VCTube</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#020617;
  color:#fff;
}
header{
  text-align:center;
  padding:12px;
  font-size:22px;
  font-weight:bold;
  box-shadow:0 0 20px #0ea5e9;
}
#controls{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  justify-content:center;
  padding:10px;
}
input,button{
  padding:10px;
  border-radius:6px;
  border:none;
  font-size:14px;
}
input{
  background:#020617;
  border:1px solid #0ea5e9;
  color:#fff;
}
button{
  background:linear-gradient(135deg,#0ea5e9,#22d3ee);
  font-weight:bold;
  cursor:pointer;
}
#roomInfo{
  text-align:center;
  color:#38bdf8;
  margin-bottom:5px;
}
#videoGrid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:10px;
  padding:10px;
}
video{
  width:100%;
  height:180px;
  background:#000;
  border-radius:12px;
  object-fit:cover;
  transform:scaleX(-1);
}
#end{
  text-align:center;
  padding:10px;
}
#end button{
  background:red;
  color:#fff;
}
</style>
</head>

<body>

<header>VCTube</header>

<div id="controls">
  <input id="name" placeholder="Your Name">
  <input id="room" placeholder="Room Code (blank = host)">
  <button onclick="start()">Create / Join</button>
</div>

<div id="roomInfo"></div>
<div id="videoGrid"></div>

<div id="end" style="display:none">
  <button onclick="endCall()">Cut Call</button>
</div>

<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
let peer;
let localStream;
let activeCall;

async function start(){
  const userName = document.getElementById("name").value.trim();
  let roomCode = document.getElementById("room").value.trim();

  if(!userName){
    alert("Enter your name");
    return;
  }

  // HOST generates room code
  if(!roomCode){
    roomCode = Math.random().toString(36).substring(2,8).toUpperCase();
  }

  document.getElementById("roomInfo").innerText =
    "Room Code: " + roomCode + " (Share this)";

  // IMPORTANT: peer ID = unique per user
  peer = new Peer(userName + "-" + Math.random().toString(36).substring(2,6));

  // Get media (desktop-safe)
  localStream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:"user"},
    audio:true
  });

  addVideo(localStream, true);

  // Incoming call (host side)
  peer.on("call", call=>{
    document.getElementById("beep").play();
    if(confirm(call.metadata.name + " wants to join")){
      call.answer(localStream);
      handleCall(call);
    }else{
      call.close();
    }
  });

  peer.on("open", ()=>{
    // If JOINER, call host
    if(document.getElementById("room").value.trim()){
      const call = peer.call(roomCode, localStream, {
        metadata:{name:userName}
      });
      handleCall(call);
    }
    document.getElementById("end").style.display="block";
  });

  // HOST listens using roomCode
  if(!document.getElementById("room").value.trim()){
    peer.destroy();
    peer = new Peer(roomCode);
  }
}

function handleCall(call){
  activeCall = call;
  call.on("stream", stream=>{
    addVideo(stream,false);
  });
}

function addVideo(stream,isLocal){
  const v = document.createElement("video");
  v.srcObject = stream;
  v.playsInline = true;
  v.autoplay = true;
  v.muted = true; // REQUIRED FOR DESKTOP
  v.onloadedmetadata = ()=>{
    v.play().catch(()=>{});
  };
  document.getElementById("videoGrid").appendChild(v);
}

function endCall(){
  if(activeCall) activeCall.close();
  if(peer) peer.destroy();
  location.reload();
}
</script>

</body>
</html>
