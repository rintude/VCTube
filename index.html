<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VCTube</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
body {
  margin: 0;
  background: #020617;
  color: #fff;
  font-family: Arial, sans-serif;
}
header {
  text-align: center;
  padding: 12px;
  font-size: 22px;
  font-weight: bold;
  box-shadow: 0 0 20px #0ea5e9;
}
#controls {
  display: flex;
  gap: 8px;
  justify-content: center;
  padding: 10px;
  flex-wrap: wrap;
}
input, button {
  padding: 10px;
  border-radius: 6px;
  border: none;
}
input {
  background: #020617;
  border: 1px solid #0ea5e9;
  color: #fff;
}
button {
  background: linear-gradient(135deg,#0ea5e9,#22d3ee);
  font-weight: bold;
  cursor: pointer;
}
#roomInfo {
  text-align: center;
  color: #38bdf8;
}
#videoGrid {
  display: grid;
  grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
  gap: 10px;
  padding: 10px;
}
video {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border-radius: 12px;
  background: #000;
  transform: scaleX(-1);
}
#endBtn {
  text-align: center;
  padding: 10px;
}
#endBtn button {
  background: red;
  color: white;
}
</style>
</head>

<body>

<header>VCTube</header>

<div id="controls">
  <input id="name" placeholder="Your Name">
  <input id="room" placeholder="Room Code (leave blank to host)">
  <button onclick="start()">Create / Join</button>
</div>

<div id="roomInfo"></div>
<div id="videoGrid"></div>

<div id="endBtn" style="display:none">
  <button onclick="endCall()">Cut Call</button>
</div>

<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
let peer, localStream, currentCall;

async function start() {
  const name = nameInput.value.trim();
  let room = roomInput.value.trim();

  if (!name) return alert("Enter your name");

  if (!room) {
    room = Math.random().toString(36).substring(2,8).toUpperCase();
  }

  roomInfo.innerText = "Room Code: " + room;
  peer = new Peer(room);

  localStream = await navigator.mediaDevices.getUserMedia({
  video: { facingMode: "user" },
  audio: true
});
  addVideo(localStream);

  peer.on("call", call => {
    beep.play();
    if (confirm(call.metadata.name + " wants to join")) {
      call.answer(localStream);
      handleCall(call);
    } else call.close();
  });

  peer.on("open", id => {
    if (roomInput.value) {
      const call = peer.call(room, localStream, {metadata:{name}});
      handleCall(call);
    }
    endBtn.style.display = "block";
  });
}

function handleCall(call) {
  currentCall = call;
  call.on("stream", stream => addVideo(stream));
}

function addVideo(stream) {
  const v = document.createElement("video");
  v.srcObject = stream;
  v.autoplay = true;
  v.playsInline = true;
  v.muted = true;          // ✅ REQUIRED FOR DESKTOP
  v.onloadedmetadata = () => {
    v.play().catch(()=>{}); // ✅ FORCE PLAY
  };
  videoGrid.appendChild(v);
}


function endCall() {
  if (currentCall) currentCall.close();
  if (peer) peer.destroy();
  location.reload();
}

const nameInput = document.getElementById("name");
const roomInput = document.getElementById("room");
const roomInfo = document.getElementById("roomInfo");
const videoGrid = document.getElementById("videoGrid");
const endBtn = document.getElementById("endBtn");
const beep = document.getElementById("beep");
</script>

</body>
</html>
